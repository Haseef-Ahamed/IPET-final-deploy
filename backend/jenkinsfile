pipeline {
    agent any
    tools { nodejs 'NodeJS25'}
    environment { 
        WORKDIR = "backend" 
        }
    stages {
        stage('Checkout') { 
            steps { 
                git branch: 'main', changelog: false, credentialsId: 'f668feb1-9848-44b0-a272-a742c137922b', poll: false, url: 'https://github.com/Haseef-Ahamed/IPET-final-deploy.git'
                } 
            }
        stage('Install Dependencies') {
            steps { 
                dir("${WORKDIR}") { 
                    sh 'npm ci' 
                    } 
                }
        }
        stage('Lint') {
            steps { 
                dir("${WORKDIR}") { 
                    sh 'npx eslint .' 
                    } 
                }
        }
        stage('Test') {
            steps {
                 dir("${WORKDIR}") {
                    sh 'npm ci'
                    sh 'npm run mocha'
                // Install the JUnit reporter if missing
                    // sh 'npm install --save-dev mocha-junit-reporter'
                // Run Mocha with npm test if scripted, or directly; assumes package.json has "test": "mocha test/**/*.js"
                    // sh 'npm test -- --reporter mocha-junit-reporter --reporter-options mochaFile=./test-results.xml'
                    // Alternative direct Mocha run if npm script not configured
                    // sh 'npx mocha --reporter mocha-junit-reporter --reporter-options mochaFile=./test-results.xml test/**/*.js'
                 }
            }
            post {
             always {
                junit "${WORKDIR}/test-results.xml"
            }
            success {
                echo 'Tests passed successfully.'
            }
            failure {
                echo 'Mocha tests failed. Please check the test results.'
            }
            }
        }
        stage('Security Audit') {
            steps { 
                dir("${WORKDIR}") { 
                    sh 'npm audit --audit-level=high' 
                } 
            }
        }

        // stage('Build') { 
        //     steps {
        //         dir("${WORKDIR}") {
        //             sh 'npm run build'
        //         }
        //     }
        //     post {
        //         success {
        //            archiveArtifacts artifacts: "${WORKDIR}/dist/**", onlyIfSuccessful: true
        //         }
        //     }
        // }
        // stage('Build Docker Image') {
        //     steps { dir("${WORKDIR}") 
        //         { 
        //         sh 'docker build -t my-backend:latest .' 
        //         } 
        //     }
        // }
        // Add 'Push to Docker Hub' and K8s deploy stages as your infra matures
    }
    post {
        always { echo "Finished backend CI pipeline." }
    }
}

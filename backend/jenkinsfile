pipeline {
    agent any
    tools { nodejs 'NodeJS25'}
    environment { 
        WORKDIR = "backend" 
        }
    stages {
        stage('Checkout') { 
            steps { 
                checkout scm
                 } 
            }
        stage('Install Dependencies') {
            steps { 
                dir("${WORKDIR}") { 
                    sh 'npm ci' 
                    } 
                }
        }
        stage('Lint') {
            steps { 
                dir("${WORKDIR}") { 
                    sh 'npx eslint .' 
                    } 
                }
        }
        // stage('Test') {
        //     steps { 
        //         dir("${WORKDIR}") { 
        //             sh 'npm test --save-dev mohca-junit-reporter'
        //             sh 'npx mocha --reporter mohca-junit-reporter --reporter-options mochaFile=./test-results.xml'
        //             } 
        //         }
        //         post {
        //             always {
        //                 junit "${WORKDIR}/test-results.xml"
        //             }
        //             success {
        //                 echo 'Tests passed successfully.'
        //             }
        //             failure {
        //                 echo 'mocha tests failed. Please check the test results.'
        //             }
        //         }
        // }
        stage('Security Audit') {
            steps { 
                dir("${WORKDIR}") { 
                    sh 'npm audit --audit-level=high' 
                } 
            }
        }

        // stage('Build') { 
        //     steps {
        //         dir("${WORKDIR}") {
        //             sh 'npm run build'
        //         }
        //     }
        //     post {
        //         success {
        //            archiveArtifacts artifacts: "${WORKDIR}/dist/**", onlyIfSuccessful: true
        //         }
        //     }
        // }
        // stage('Build Docker Image') {
        //     steps { dir("${WORKDIR}") 
        //         { 
        //         sh 'docker build -t my-backend:latest .' 
        //         } 
        //     }
        // }
        // Add 'Push to Docker Hub' and K8s deploy stages as your infra matures
    }
    post {
        always { echo "Finished backend CI pipeline." }
    }
}
